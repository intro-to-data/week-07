---
title: "Lab Week 07"
output:
  md_document:
    variant: markdown_github
---

```{r}
knitr::include_graphics("https://imgs.xkcd.com/comics/substitute.png")
```



# Lab


## Setup

```{r message = FALSE, warning = FALSE}
rm(list =)
library(DBI)
library(dbplyr)
library(knitr)
library(RSQLite)
library(tidyverse)
con <- dbConnect(RSQLite::SQLite(), dbname = "./data/Chinook_Sqlite.sqlite")
chinook_tables <- dbListTables(con)
Album <- con %>% tbl("Album")
Artist <- con %>% tbl("Artist")
Customer <- con %>% tbl("Customer")
Employee <- con %>% tbl("Employee")
Genre <- con %>% tbl("Genre")
Invoice <- con %>% tbl("Invoice")
InvoiceLine <- con %>% tbl("InvoiceLine")
MediaType <- con %>% tbl("MediaType")
Playlist <-  con %>% tbl("Playlist")
PlaylistTrack <-  con %>% tbl("PlaylistTrack")
Track <-  con %>% tbl("Track")
```

To test if you have successfully loaded the data, try to run the following code chunk. You should get the same results I show below. 

```{r}
Playlist %>% arrange(Name) %>% collect(n = 6)
```

You should get back the first six rows of the `Playlist` table, which should include exciting playlist names such as:

| PlaylistId | Name                      |
|:----------:|:--------------------------|
| 5          | 90's Music                |
| 4          | Audiobooks                |
| 6          | Audiobooks                |
| 11         | Brazillian Music          |
| 12         | Classical                 |
| 13         | Classical 101 - Deep Cuts |

Above, there are two playlists with the same name (Audiobooks). Although they have the same name, they have different PlaylistId numbers. This _is_ important. In this table, `PlaylistId` is the primary key. Remember when we joined two data sets by county name and fips code? Names are tricky and prone to silly errors. It is better to use an ID number as a primary key. A primary key _MUST_ be unique. It cannot have a duplicate (dupe). The playlist names can dupe (although doing so will cause some confusion among the humans) but for the database, `PlaylistId` "4" and "6" _are_ unique. That said, I don't understand the fascination with audiobooks. If it is a good book, you should read it. If it isn't good enough to read, why would you pay someone to read it to you?

## Task 01. Where are my Audiobook playlists?

In `Playlist`, there are two "Music" playlists. Or, are there? Take a look at the following code chunks. The results may be surprising (although they are correct). Your goal is to be able to explain why:

```{r}
## Returns all playlist names in Playlist which have more than one entry.
## Music IS returned here.
Playlist %>%
    group_by(Name) %>%
    count() %>%
    ## By applying a filter AFTER I group by/summarize, I can filter out
    ## playlist names which appear only once.
    filter(n > 1) %>%
    arrange(desc(n))
```

```{r}
Playlist %>%
    inner_join(PlaylistTrack, by="PlaylistId") %>%
    filter(Name == "Audiobooks") %>% 
    select(PlaylistId) %>%
    distinct()
```

No data set is perfect and there are two playlists named "Audiobooks", "Movies", and "Music", and "TV Shows". Each name is duped twice. Fortunately, `PlaylistId` is never duped.

```{r}
## This proves that PlaylistId is unique.
## If a PlaylistId was duplicated, this would show us which one it was.
## But, since it returns nothing . . . . WIN!
Playlist %>%
    group_by(PlaylistId) %>%
    count() %>%
    filter(n > 1) %>%
    arrange(desc(n))
```

Now, look at the following code chunk, and run it. 

This performs an INNER JOIN between `Playlist` and `PlaylistTrack`. It then filters down to only those playlists named "Audiobooks". So, we would expect to see all the tracks where `PlaylistId` is 4 or 6, right? Take a moment and scroll through the results.

```{r}
Playlist %>%
    inner_join(PlaylistTrack, by="PlaylistId") %>%
    filter(Name == "Audiobooks")
```

But, the code returns _NOTHING_. Why? Perhaps, we should dig deeper. In the code chunk above, change `inner_join` to `left_join` and rerun the code.You should get different results. In fact, the results lead us directly the epistemological question of this lab: Can you have a playlist with no tracks? Can that be a thing?

If you still aren't sure what is going on, I recommend reviewing [mutating joins](https://r4ds.had.co.nz/relational-data.html#mutating-joins) from our text. When you think you are ready, go to canvas and see if you can get the right answer to the very important question waiting for you there.

## Task 02. Which playlist name has the most tracks?

Adapting the code from Task 01, which playlist has the most tracks?
You can use `inner_join()` for this task.

```{r eval = FALSE}
## Task 02: Which playlist name has the most tracks?
Playlist %>%
    inner_join()
```

```{r echo = FALSE, eval = FALSE}
## Task 02: Which playlist name has the most tracks?
Playlist %>%
    inner_join(PlaylistTrack, by="PlaylistId") %>%
    group_by(PlaylistId, Name) %>%
    count() %>%
    arrange(desc(n))
```

## Task 03: How many tracks in Music, where `PlaylistID == 8`?

Based on your code above OR a slight tweak of it, how many tracks are
in the Playlist named "Music" with `PlaylistId == 8`?

**Hint:** Depending on how you wrote your code for Task 02, getting
the right answer may seem unnecessarily hard. Remember, programming is
the art of being painfully specific. It is even more fun because human
language is frequently vague and the people who write questions for
analysts never know what they are talking about.

**Hint:** The function, `foo()` is not a function. It is a placeholder
for all the _awesome_ you are about to do.

```{r eval = FALSE}
## Task 03: How many tracks in Music, where PlaylistID == 8?
Playlist %>%
    foo()
```

```{r echo = FALSE, eval = FALSE}
## Task 03: How many tracks in Music, where PlaylistID == 8?
Playlist %>%
    filter(PlaylistId == 8) %>%
    inner_join(PlaylistTrack, by="PlaylistId") %>%
    group_by(PlaylistId, Name) %>%
    count()
```

## Task 04: Media Type

The table, `MediaType`, is a reference table. It maps `MediaTypeId`
to a name of each media type. You can find this same column name in
the `Track` table. A reference table differs from a table like
`Customers` in that the values of a reference table are defined by our
internal/external business logic. It is a reference for a value. A
table like `Customers` houses actual data.

The `MediaType` table helps us answer two questions:

1. Which media type has the most tracks?
2. What is the total play length of this media type (in milliseconds)?

You can answer this with a single bit of code. First you need to join
`Track` and `MediaType`. Then `group_by()` the media type. Finally,
use `summarize()` to count the number of each media type track AND
`sum()` the length of each media type. Your previous code uses
different tables, but should help you get started.

There is one "gotcha" to this task. There is a `Name` column in both
`Track` and `MediaType`. In R, two columns ARE NOT allowed to have
the same name, which they would after the join. You could rename the
`Name` column in one table, or let R handle this for you. If you let R
handle this, the column `Name` from `Track` will become `Name.x` and
`Name` in `MediaType` will become `Name.y`. I let R rename the
columns for me, but doing so has implications for how I should write
my `group_by()` command.

Because it may make it easier, the code stub I am providing below will
create a new table called `TrackMediaType`. Complete the join and
create `TrackMediaType`. Then perform any grouping and filtering you
need on `TackMediaType`. Remember, you can use RStudio to view your
data, which may make it easier to get the column names for the
`group_by()`. Spelling/capitalization matters!

**Hint:** Little steps make complex things easier!

```{r eval = FALSE}
## Task 04: Media Type
TrackMediaType <- 
    Track %>%
    inner_join()

TrackMediaType %>%
    group_by() %>%
    summarize()
```

```{r echo = FALSE, eval = FALSE}
## Task 04: Media Type
Track %>%
    inner_join(MediaType, by="MediaTypeId") %>%
    group_by(MediaTypeId, Name.y) %>%
    summarize(N = n(), L = sum(Milliseconds)) %>%
    arrange(desc(N))
```

In canvas, you will find that this task has two questions associated
with it.

## Task 05: Who is the best customer?

Who is our best customer? Using `FirstName` and `LastName` from
`Customers`, tell me which customer has spent the most money at the
store. To calculate total money spent, look at the `Total` column in
`Invoices`.

This is just like some of the other tasks we have done. Join the two
tables, group by `FirstName`, `LastName`, and `CustomerId` and then
find the `sum()` of the `Total` column. Make sure you include
`CustomerId` in your grouping. Wouldn't you feel silly if two
customers have the same name and combined they have the most
purchases?

I recommend first making a `CustomerInvoices` table. You will use this
new table for several tasks below.

**Hint:** Invoice value is in the `Total` column.

```{r eval = FALSE}
## Task 05: Who is the best customer?
CustomerInvoices <- 
    Customers %>%
    inner_join()
```

```{r echo = FALSE, eval = FALSE}
CustomerInvoices <- 
    Customers %>%
    inner_join(Invoices, by = "CustomerId")

CustomerInvoices %>%
    group_by(CustomerId, FirstName, LastName) %>%
    summarize(Money = sum(Total)) %>%
    arrange(desc(Money)) %>%
    knitr::kable()
```

## Task 06: Which country is the best customer?

Rather than group by customer-specific identifiers, now you need to
`group_by()` by `Country`. Then tell me which country has made the
highest total number of purchases AND the highest average
purchase. This will be two different questions on Canvas.

1. Which country has spent the most total money?
2. Which country has the highest average purchase price?

**Hint:** The country with the most total purchases may not be the
country with the highest average purchase. Life == complicated.

If you followed directions in Task 05 and created a `CustomerInvoices`
table, congratulations! You can use that table to complete this
task. If you didn't, well, you are going to have to join `Customers`
and `Invoices` together again. My condolences.

```{r eval = FALSE}
## Task 06 Which country is the best customer?
## Which country has spent the most total money?
CustomerInvoices %>%
    group_by() %>%
    summarize()

## Task 06 Which country is the best customer?
## Which country has the highest average purchase price?
CustomerInvoices %>%
    group_by() %>%
    summarize()
```

```{r echo = FALSE, eval = FALSE}
## Task 06 Which country is the best customer?

CustomerInvoices %>%
    group_by(Country) %>%
    summarize(T = sum(Total),
              A = mean(Total),
              M = median(Total),
              N = length(InvoiceId)
             ) %>%
    arrange(desc(M))
```

## Task 07: Graphing Invoice Value by Country

Above you calculated the total value of invoices from a country AND
you calculated the average value of an invoice from a country. Now, I
want you to look at the distribution of invoice values by
country. Using ggplot, create a box & whiskers plot
([hint](https://ggplot2.tidyverse.org/reference/geom_boxplot.html)) of
invoice totals by country. To complete this task, you should use
`CustomerInvoices`, again. For each country, I would like to see the
distribution of invoice values in your plot.

**Hint 01:** The dark bar in the "middle" of the box shows us the median value.

Questions:

- Which country has the highest median invoice value? If you don't
  trust yourself, feel free to adjust your transformation from the
  previous task to calculate the per country median and confirm what
  you see in the plot.
- Which country has the largest variance of invoice value?  (Think
  about what that means for the average invoice value of this
  country.)
- Which country has the single biggest invoice?
- Please upload your graph.

Because there are many countries, reading a ggplot graph where the
text is horizontal would be ~difficult~ impossible. To help, I am
providing some help in the code stub below. It will work best if the
`theme()` command is the last line of your `ggplot()`. You are
responsible for the rest of the code to make the plot work. And no,
there is no `geom_foo()`. You need to figure out the name of the
function. I did give you a hint.

```{r eval = FALSE}
## Task 07: Graphing Invoice Value by Country
ggplot() +
    geom_foo() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .25))
```

```{r echo = FALSE, eval = FALSE}
ggplot(CustomerInvoices, aes(x = Country, y = Total)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .25))
```

## Task 08: Graphing Importance Of Volume

- Is there a relationship between the number of Invoices from a
  country and the total value of Invoices from that country? In other
  words, does the number of Invoices predict the total value of
  purchases?
- Is there a relationship between the number of Invoices from a
  country and the average value of an Invoice from that country? In
  other words, does the number of Invoices predict the average value
  of a purchase?
- Based on this data, which do you feel you would be able to predict
  more accurately? Total value of invoices per country of the average
  value of invoices per country?

To complete this task, you will need to create another new table. I
would call it `CountryTotals`. Take the data in `CustomerInvoices` and
group by the `Country` column. You will need to transform the data
(which will change the grain of the data) to give you the per country:

- `sum()` of Total
- `mean()` of Total
- `median` of Total
- `length()` Number of Invoices

Once you have these calculated values in `CountryTotals`, use this new
grain of data to anser the questions above. You will need to use
ggplot to produce two scatter plots. The number of invoices per
country should be the X-Axis. The total value of invoices and the
average value price should be the Y-Axis. I recommend graphing the
regression line (linear). Once you have done so, you should be able to
answer the questions.

Again, there is a text-related issue to making these plots. I have
provided you some code in `geom_text()` which should help.

```{r eval = FALSE}
## Task 08: Graphing Importance Of Volume

## CountryTotals
CountryTotals <-
    CustomerInvoices %>%
    foo()

## Y-Axis = sum of Total
ggplot() +
    geom_foo() +
    geom_text(aes(label = Country), hjust = 1, vjust = -1)

## Y-Axis = average of Total
ggplot() +
    geom_foo() +
    geom_text(aes(label = Country), hjust = 1, vjust = -1)
```

```{r echo = FALSE, eval = FALSE}

CountryTotals <-
    CustomerInvoices %>%
    group_by(Country) %>%
    summarize(T = sum(Total),
              A = mean(Total),
              M = median(Total),
              N = length(InvoiceId)
             )

ggplot(CountryTotals, aes(x = N, y = T)) +
    geom_point() +
    geom_smooth(method = lm) +
    geom_text(aes(label = Country), hjust = 1, vjust = -1)

ggplot(CountryTotals, aes(x = N, y = A)) +
    geom_point() +
    geom_smooth(method = lm) +
    geom_text(aes(label = Country), hjust = -.125, vjust = -1)

```

## Task 09: Please upload your .R file.

Upload your .R file in Canvas and good luck on the midterm exam!

